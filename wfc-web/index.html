<!DOCTYPE html>
<html>
  <head>
    <link data-trunk rel="rust" />
    <link data-trunk rel="css" href="./tailwind.css" />
    <link data-trunk rel="copy-dir" href="assets" />
  </head>

  <body>
    <script>
      let controller = undefined;

      let togglePlaying = () => {};

      function assert(condition, message = "") {
        if (!condition) {
          throw new Error("Failed Assertion:" + message);
        }
      }
      function togglePresetMenu() {
        presetMenu = document.querySelector("#presets .dropdown-menu");
        presetMenu.classList.toggle("hidden");
      }
      // TODO: non wang tiles
      // TODO: specifying settings in menu
      // TODO: uploading images
      async function wangTileBytes(wang_tile) {
        const path = `./assets/wang/${wang_tile}.png`;
        const bytes = await fetch(path)
          .then((response) => response.blob())
          .then((blob) => {
            const reader = new FileReader();
            reader.readAsArrayBuffer(blob);
            return new Promise((resolve, reject) => {
              reader.onloadend = function () {
                const u8Array = new Uint8Array(reader.result);
                resolve(u8Array);
              };
              reader.onerror = function () {
                reject(reader.error);
              };
            });
          });
        return bytes;
      }
      async function playGame(game) {
        console.log("selectGame", game);
        assert(window.wasm !== undefined, "wasm not loaded");
        if (game == "simple_patterns") {
          window.wasm.run_simple_patterns();
        } else {
          const bytes = await wangTileBytes(game);
          let wfc = window.wasm.WfcWebBuilder.new_from_image_bytes(bytes)
            .with_tile_size(32)
            .with_output_dimensions(256, 256)
            .wang()
            .build();
          // TODO: wfc.play blocks so get event_loop_proxy
          // before starting and create function in js
          // that sends custom play/pause events to the event loop
          controller.start_wfc(wfc);
          // render();
        }
      }
      async function init() {
        console.log("init");
        for (let button of document.querySelectorAll('[data-type="menu"]')) {
          button.addEventListener("click", (e) => playGame(button.value));
        }
        function waitUntilDefined(value) {
          return new Promise((resolve) => {
            if (value() !== undefined) {
              resolve(value());
            } else {
              console.log("waiting for wasm");
              const intervalId = setInterval(() => {
                console.log("checking for wasm");
                if (value() !== undefined) {
                  clearInterval(intervalId);
                  resolve(value());
                }
              }, 1);
            }
          });
        }
        await waitUntilDefined(() => window.wasm);
        let display = await window.wasm.WfcWindow.new();
        controller = window.wasm.WfcController.init(display);
        togglePlaying = () => controller.toggle_playing();
        display.start_event_loop();
        console.log("wasm loaded");
      }
      window.onload = init;
    </script>

    <div id="board" class="flex h-screen w-screen">
      <!-- TODO: display menu on side when w > h and below when h > w -->
      <div id="menu" class="flex-shrink-0 bg-gray-200 w-48 h-screen">
        <div id="presets" class="dropdown relative">
          <button onclick="togglePresetMenu()" class="block">Presets</button>
          <ul class="dropdown-menu hidden p-4">
            <li>
              <button
                class="block px-4 py-2 hover:bg-gray-300"
                data-type="menu"
                value="dual"
              >
                Dual
              </button>
            </li>
            <li>
              <button
                class="block px-4 py-2 hover:bg-gray-300"
                data-type="menu"
                value="celtic"
              >
                Celtic
              </button>
            </li>
          </ul>
        </div>
        <button
          class="block px-4 py-2 hover:bg-gray-300"
          onclick="togglePlaying()"
        >
          Play/Pause
        </button>
      </div>
      <div
        id="canvas-container"
        class="flex items-center justify-center h-screen w-full"
      >
        <canvas class="object-contain h-full w-full" id="wfc"></canvas>
      </div>
    </div>
  </body>
</html>
